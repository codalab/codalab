{% extends 'base.html' %}
{% load staticfiles %}
{% load codalab_tags %}
{% load tz %}
{% load humanize %}

{% block page_title %}
    <div class="row">
        <div class="col-lg-12">
            <h2 class="comp-title" style="">{{ competition.title }}</h2>
            <h6 class="comp-organizer" style="">Organized by {{ competition.creator }}</h6>
        </div>
    </div>
{% endblock page_title %}

{% block extra_scripts %}
    <script src="{{ STATIC_URL }}js/vendor/readmore.min.js"></script>

    <script src="{{ STATIC_URL }}js/vendor/jquery.tablesorter.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/riot@3.11/riot+compiler.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2/dist/purify.min.js"></script>

    <style>
        body {
            background-color: rgba(233, 233, 233, 1)
        }

        #public_submission_table th b {
            cursor: pointer;
        }

        .header-count {
            margin-left: 1% !important;
            margin-right: 1% !important;
            font-size: 16px !important;
            font-weight: bolder !important;
            font-family: "Segoe UI", "SansSerif";
        }

        .comp-view-well {
            padding: 0;
            margin-bottom: 0;
            margin-top: 0;
        }

        .comp-view-image {
            width: 100%;
            height: auto;
            max-height: 150px;
            max-width: 150px;
            padding: 2px;
{#            border: solid 1px #dddddd;#}
        }

        .comp-view-countdown-well {
            background-color: rgba(255, 79, 79, 1);
            display: inline-block;
        }

        .comp-view-image-col {
{#            border: 2px solid rgba(0, 0, 0, 0.1);#}
            padding: 0;
{#            background-color: rgba(233, 233, 233, 1);#}
            overflow: hidden;
        }

        .comp-view-status {
            background-color: rgba(130, 165, 195, 0.5);
            min-width: 50%;
            display: inline-block;
        }

        .comp-info {
            margin: 2vh 0 2vh 0 !important;
            padding: 1vh 1vw 1vh 1vw !important;
        }

        .comp-view-tab-container {
            max-height: 10%;
            padding-left: 0;
        }

        .comp-view-tabs {
            margin: 12.5vh 0 0 0 !important;
        }

        .comp-tab-list {
{#            margin-left: 25vw;#}
{#            margin-right: 25vw;#}
{#            text-align: center;#}
        }

        hr {
            margin-top: 15px;
            margin-bottom: 15px;
        }

        table {
            margin-bottom: 0 !important;
        }

        .table td {
            text-align: center;
        }

        .table th {
            text-align: center;
        }

        .comp-organizer {

            display: inline-block;
            float: right;
            margin-top: 5vh;
            margin-bottom: 0;
        }

        @media only screen and (max-width: 600px) {
            .comp-organizer {
                display: block;
                float: left;
                margin-top: 0;
            }
        }

        .comp-title {
            display: inline-block;
        }

        @media only screen and (max-width: 600px) {
            .comp-title {
                display: block;
{#                float: left;#}
{#                margin-top: 0;#}
                font-size: 18px;
                line-height: 0;
            }
        }

        .selected {
            box-shadow: 1px 1px 4px 0.5px black inset !important;
        }

{#        @media print {#}
{#            .container {#}
{#                width: auto;#}
{#            }#}
{#        }#}
{##}
{#        select {#}
{#            text-indent: 6px;#}
{#            line-height: 30px;#}
{#        }#}
    </style>
{% endblock %}

{% block content %}

    {% if is_admin_or_owner %}
        <h3>Admin features</h3>
        <a href="{% url "competitions:edit" pk=competition.pk %}" class="btn btn-primary">Edit</a>
        <a href="{% url 'my_competition_participants' competition_id=competition.pk %}" class="btn btn-primary">
            Participants
            {% if comp_num_pending_teams > 0 %}
                <span class="glyphicon glyphicon-exclamation-sign" style="color:red"></span>
            {% endif %}
        </a>
        <a href="{% url 'my_competition_submissions' competition_id=competition.pk %}" class="btn btn-primary">Submissions</a>
        <a href="{% url 'competitions:dumps' competition_pk=competition.pk %}" class="btn btn-primary">Dumps</a>
        <a href="{% url "competitions:download" competition_pk=competition.pk %}" class="btn btn-primary">
            Download Original Competition Bundle!
        </a>
        {% if not competition.publicly_available %}
            <br>
            <a href="{% url "competitions:view" pk=competition.pk %}?secret_key={{ competition.secret_key }}">
                <code>http://{{ site }}{% url "competitions:view" pk=competition.pk %}?secret_key={{ competition.secret_key }}</code>
            </a>
        {% endif %}
        <hr>
    {% endif %}

    <div class="competition-view row well comp-view-well" style="">
        <div align="center" style="" class="col-sm-2 comp-view-image-col">
            {% if competition.image_url %}
                <img class="comp-view-image" style=""
                     src="{{ competition.image_url }}">
            {% else %}
                <img class="comp-view-image" style=""
                     src="{% static "img/ProfileImageDummy.jpg" %}">
            {% endif %}
        </div>
        <div align="center" style="padding: 0;" class="col-sm-10">
            <div class="row">
                {% if competition.end_date %}
                    <div style="" class="well comp-view-countdown-well col-sm comp-info">
                        <div style="color: white;" class="date">
                            <i style="color: white; font-size: 14px;" class="glyphicon glyphicon-bell"></i> {{ competition.end_date|timeuntil:timezone_now }} to go
                        </div>
                    </div>
                {% endif %}

                <input type="hidden" id="competitionId" value="{{ competition.id }}"/>
                <input type="hidden" id="cstoken" value="{{ csrf_token }}"/>

                <div style="" class="well competition-status comp-view-status col-sm comp-info">
                    <ul style="" class="list-inline">
                        <li class="header-count">{{ participant_count }} Participants</li>

                        {% if competition.enable_teams %}
                            <li class="header-count">{{ team_count }} Teams</li>{% endif %}
                        <li class="header-count">{{ submission_count }} Submissions</li>

                        {% if competition.reward %}
                            <li class="header-count">{{ competition.reward }} Prize</li>
                        {% endif %}
                    </ul>
                </div>
                {% if user.is_authenticated %}
                    <a class="well col-sm comp-info" style="display: inline-block; color: white; background-color: #2185d0;" href="#participate" id="submission_top_pointer">
                        Upload a Submission
                    </a>
                {% endif %}
            </div>
            <ul class="list-inline">
                {% if competition.end_date %}
                        <li style="font-weight: bolder;">
                            Competition Ends: {{ competition.end_date }}
                        </li>
                        <li style="font-weight: bolder;">
                            Server Time: {{ current_server_time.time }} UTC
                        </li>
                {% endif %}
            </ul>
        </div>
        <div align="center" style="margin-left: 0; margin-right: 0;" class="row comp-view-tab-container">
            <section style="" class="competition-tabs comp-view-tabs">
                {#                <ul class="nav nav-tabs" id="competition_tab_nav">#}
                <ul style="" class="text-center list-inline nav nav-justified nav-pills comp-tab-list" id="competition_tab_nav">
                    {% for tab, contents in tabs.items %}
                        <li class="nav-item"><a class="nav-link" href="#{{ tab.codename|slugify }}" role="tab"
                               data-toggle="tab">{{ tab.name }}</a></li>
                        {% if tab.codename == "results" %}
                            {#         Put this after results tab#}
                            {% if competition.allow_public_submissions %}
                                <!--<li><a href="#public_submissions" role="tab" data-toggle="tab">Public submissions</a></li>-->
                                <li><a class="" href="{% url 'competitions:public_submissions' pk=competition.pk %}">Public
                                    Submissions</a></li>
                            {% endif %}
                            {% if competition.enable_forum %}
                                <li>
                                    <a class="" href="{% url 'forum_detail' forum_pk=competition.forum.pk %}">
                                        Forums <i class="glyphicon glyphicon-log-in"></i>
                                    </a>
                                </li>
                            {% endif %}
                            {% if competition.enable_teams %}
                                {% if my_status == "approved" %}
                                    <li>
                                        <a class="" href="{% url 'team_detail' competition_pk=competition.pk %}">Team
                                            <i class="glyphicon glyphicon-cog"></i>
                                            {% if new_team_submission > 0 %}
                                                <span class="label label-danger">{{ new_team_submission }}</span>
                                            {% endif %}
                                            {% if my_team_alert == 1 %}
                                                <span class="glyphicon glyphicon-exclamation-sign"
                                                      style="color:red"></span>
                                            {% endif %}
                                        </a>
                                    </li>
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </ul>
            </section>
        </div>
    </div>
    <div style="" class="tab-content row">
        {% for tab, contents in tabs.items %}
            <div class="tab-pane" id="{{ tab.codename|slugify }}">
                <div class="tab-inner">
                    {% if tab.codename == "participate" %}
                        {% if not user.is_authenticated %}
                            <p>You must be logged in to participate in competitions.</p>
                            <a href="{% url 'account_login' %}?next=/competitions/{{ competition.id }}%23participate-get-data"
                               class="btn btn-primary">Sign In</a>
                        {% else %}
                            {% if my_status == "unknown" %}
                                <form id="participate_form">
                                    {% csrf_token %}
                                    <p>You have not yet registered for this competition.</p>
                                    {% if competition.registration_required %}
                                        <p>To participate in this competition, you must accept its specific
                                            terms and conditions. After you register, the competition organizer
                                            will review your application and notify you when your participation
                                            is approved.</p>
                                    {% endif %}
                                    <div class="checkbox">
                                        <label>
                                            <input type="checkbox" name="agreed_terms" id="checkbox" required onclick="Competition.registationCanProceed();">
                                            I accept the <a href="#learn_the_details-terms_and_conditions" target="_blank">terms and conditions</a> of the competition.
                                        </label>
                                    </div>
                                    <input type="submit" id="participateButton" class="disabledStatus btn btn-primary margin-top" value="Register"/>
                                </form>
                            {% elif my_status == "pending" %}
                                <p>Your request to participate in this challenge has been received and a
                                    decision is pending.</p>
                            {% elif my_status == "denied" %}
                                <p>Your request to participate in this competition was denied or your
                                    privileges have been suspended.</p>
                                {% if my_participant.reason %}
                                    <p>Reason: {{ my_participant.reason }}</p>
                                {% endif %}
                            {% endif %}
                            {% if my_status == "approved" %}
                                {#                                {% include "web/competitions/_innertabs.html" %}#}
                                {% include "web/competitions/_submit_results.html" with competition=competition user=user %}
                            {% endif %}
                        {% endif %}
                    {% elif tab.codename == 'results' %}
                        {% include "web/competitions/_results.html" %}
                    {% else %}
                        {% include "web/competitions/_innertabs.html" %}
                    {% endif %}
                </div>
            </div>

        {% endfor %}
    </div>
    {% if competition.show_top_three and top_three %}
        <div style="margin-top: 2vh;" class="row">
            <div class="col-lg-12 well" id="top-ten-well">
                <table class="table" style="background-color: rgba(130, 165, 195, 0.5);">
                    <thead>
                    <tr style="font-size: 22px; font-weight: bolder;">
                        <th></th>
                        <th></th>
                        <th></th>
                        <th>Top Ten Results</th>
                        <th class="text-right">
                            <a id="top_three_pointer" data-toggle="tab" href="#{{ "results"|slugify }}">
                                Full Results
                                <i class="glyphicon glyphicon-chevron-up"></i>
                            </a>
                        </th>
                    </tr>
                    <tr>
                        <th>#</th>
                        <th>Username</th>
                        <th>Average Rank</th>
                        <th>Last Submission</th>
                        <th>Total Compute Time</th>
                        {% if competition.enable_teams %}
                            <th>Team</th>
                        {% endif %}
                    </tr>
                    </thead>
                    <tbody>
                    {% for leader in top_three %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ leader.username }}</td>
                            <td>{{ leader.score }}</td>
{#                            <td>{{ leader.last_submission_date|date:'d-m-Y' }}</td>#}
                            <td>{{ leader.last_submission_date}}</td>
                            <td>{{ leader.est_duration|default_if_none:'' }}</td>
                            {% if competition.enable_teams %}
                                <td>{{ leader.team }}</td>
                            {% endif %}
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}
{% endblock content %}

{% block jsincludes %}
    <script>
        $('#view_all_phases').on('click', function (e) {
            $('#competition_tab_nav a[href="#phases"]').tab('show');
        });
        $(function () {

            {% for phase in competition.phases.all %}
                {% if phase.is_parallel_parent %}
                    var parallel_parent_selector = $("#submissions_phase_" + {{ phase.id }})
                {% endif %}
            {% endfor %}

            var show_location = function (hash) {
                var main_tab = hash.split('-')[0];
                var sub_tab = hash.split('-')[1];

                $('#competition_tab_nav a[href="' + main_tab + '"]').tab('show');
                $(main_tab + ' .innertabs a[href="' + main_tab + '-' + sub_tab + '"]').tab('show');
            };

            if (location.hash !== '') {
                show_location(location.hash);
            } else {
                $('#competition_tab_nav a:first').tab('show')
            }
            $('#competition_tab_nav a, .innertabs a').on('show.bs.tab', function (e) {
                return location.hash = $(e.target).attr('href').substr(1);
            });
            {#            if ($('#participate-submit_results').hasClass('active')) {#}
            {#                $('#submissions_phase_buttons .active').click();#}
            {#            } else if ($('#results').hasClass('active')) {#}
            {#                $('#results_phase_buttons .active').click();#}
            {#            };#}
            if ($('#participate').hasClass('active')) {
                $('#submissions_phase_buttons .active').click();
            } else if ($('#results').hasClass('active')) {
                $('#results_phase_buttons .active').click();
            }
            ;
            {#            $('a[href="#participate-submit_results"]').on('shown.bs.tab', function (e) {#}
            {#                $($(e.target).attr('href') + ' .active').click();#}
            {#            });#}
            $('a[href="#participate"]').on('shown.bs.tab', function (e) {
                $($(e.target).attr('href') + ' .active').click();
            });
            $('a[href="#results"]').on('shown.bs.tab', function (e) {
                $($(e.target).attr('href') + ' .active').click();
            });

            $('#learn_the_details .col-sm-9 a').on('click', function () {
                show_location('#' + $(this).attr('href').split('#')[1]);
            });

            $('#top_three_pointer').on('click', function () {
                show_location('#' + $(this).attr('href').split('#')[1]);
            });
{#            $('#submission_top_pointer').on('click', function () {#}
            $('#submission_top_pointer').on('click', function () {
                if (window.location.hash !== '#participate') {
                    show_location('#' + $(this).attr('href').split('#')[1]);
                    window.setTimeout(function () {
                        var fileUploadButton = document.getElementById("fileUploadButton");
                        if (fileUploadButton !== null) {
                            fileUploadButton.click();
                        } else {
                            var fileUploadButton = document.getElementById("s3-file-upload");
                            if (fileUploadButton !== null) {
                                fileUploadButton.click();
                            } else {
                                console.log("Try again")
                                $('#submission_top_pointer').click()
                            }
                        }
                    }, 999);
                } else {
                    if (typeof parallel_parent_selector === 'undefined') {
                        var fileUploadButton = document.getElementById("fileUploadButton");
                        if (fileUploadButton !== null) {
                            fileUploadButton.click()
                        } else {
                            var fileUploadButton = document.getElementById("s3-file-upload");
                            if (fileUploadButton !== null) {
                                fileUploadButton.click();
                            }
                        }
                    } else {
                        /*if (!parallel_parent_selector.hasClass('selected')) {
                            alert("Please select the active parent phase")
                        }*/
                        var fileUploadButton = document.getElementById("fileUploadButton");
                        if (fileUploadButton !== null) {
                            fileUploadButton.click()
                        } else {
                            var fileUploadButton = document.getElementById("s3-file-upload");
                            if (fileUploadButton !== null) {
                                fileUploadButton.click();
                            }
                        }
                    }
                }
            });
        });

        var check_page_hash = function() {
{#            console.log("Hash check called")#}
            var top_ten = document.getElementById("top-ten-well");
            if (top_ten === null) {
                return
            }
            if ((!window.location.hash) || (window.location.hash === '#home' || window.location.hash === ''))
            {
                top_ten.style.display = "block";
            } else {
                top_ten.style.display = "none";
            }
        }

        window.addEventListener("hashchange", check_page_hash, false);
        window.addEventListener("load", check_page_hash, false);

        var set_next_param = function () {
            //console.log("Set Next Param Called")
            var new_hash = window.location.hash.replace('#', '')
            var div_to_check = null
            switch (new_hash) {
                case 'participate':
                    div_to_check = $('#details:visible')
                    break;
                case 'results':
                    div_to_check = $('.leaderboard-result-table:visible')
                    break;
            }
            // If we didn't get an element to check, just return
            if (div_to_check === null) {
                return
            }
            // If our element is valid
            if ( div_to_check.length ){
                // Loop through each 'detailed-results-link' class elements that are visible
                $('.detailed-results-link:visible').each(function (index) {
                    var old_href = $(this).prop('href')
                    // If our href already includes a query param, remove it and replace it with our new one. If not
                    // just tack the query param on the end of the old href.
                    if (!old_href.includes('?')) {
                        $(this).prop('href', old_href + "?next=" + new_hash)
                        //console.log(index + ": " + $(this).prop('href'))
                    }
                    else {
                        var query_index = old_href.indexOf('?')
                        var temp_href = old_href.slice(0, query_index)
                        $(this).prop('href', temp_href + "?next=" + new_hash)
                        //console.log(index + ": " + $(this).prop('href'))
                    }
                });
                //console.log("Success")
            }
            else {
                // Wait to check again for 500 ms
                window.setTimeout(set_next_param, 500)
                //console.log("Waiting for page to load")
            }
        }

        window.addEventListener("hashchange", set_next_param, false);
        window.addEventListener("load", set_next_param, false);


    </script>
{% endblock %}

{% block extra_headers %}
    {{ submission_upload_form.media }}
{% endblock %}
